<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stripe Sync Explorer</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #09090b;
      --bg-surface: #111113;
      --bg-elevated: #18181b;
      --bg-hover: #1f1f23;
      --border: #27272a;
      --border-focus: #6366f1;
      --text: #fafafa;
      --text-dim: #71717a;
      --text-muted: #52525b;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --red: #ef4444;
      --red-bg: rgba(239,68,68,0.08);
      --red-border: rgba(239,68,68,0.2);
      --green: #22c55e;
      --yellow: #eab308;
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      --font-mono: 'SF Mono', 'Cascadia Code', 'JetBrains Mono', 'Fira Code', 'Menlo', monospace;
      --radius: 8px;
    }
    html, body { height: 100%; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 52px;
      min-height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-surface);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 15px;
      letter-spacing: -0.01em;
    }
    .logo svg { flex-shrink: 0; }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 100px;
      border: 1px solid var(--border);
      color: var(--text-dim);
    }
    .status-pill .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
    }
    .status-pill.syncing .dot { background: var(--yellow); animation: pulse 1s infinite; }
    .status-pill.error .dot { background: var(--red); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ── Buttons ── */
    button {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      padding: 7px 14px;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger {
      background: var(--red-bg);
      color: var(--red);
      border: 1px solid var(--red-border);
      padding: 6px 12px;
    }
    .btn-danger:hover { background: rgba(239,68,68,0.15); }
    .btn-ghost {
      background: transparent;
      color: var(--text-dim);
      padding: 6px 10px;
    }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text); }
    kbd {
      font-family: var(--font-sans);
      font-size: 10px;
      padding: 2px 5px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
      margin-left: 4px;
    }

    /* ── Layout ── */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ── Sidebar ── */
    aside {
      width: 250px;
      min-width: 250px;
      border-right: 1px solid var(--border);
      background: var(--bg-surface);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 14px 16px 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-dim);
    }
    .query-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 8px 12px;
    }
    .query-list::-webkit-scrollbar { width: 4px; }
    .query-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .query-card {
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.1s;
      margin-bottom: 2px;
    }
    .query-card:hover { background: var(--bg-hover); }
    .query-card.active { background: rgba(99,102,241,0.1); }
    .query-card .q-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }
    .query-card .q-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* ── Content ── */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 16px;
      gap: 12px;
    }

    /* ── Editor ── */
    .editor-wrap {
      position: relative;
    }
    #editor {
      width: 100%;
      min-height: 120px;
      max-height: 40vh;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      line-height: 1.6;
      padding: 12px 14px;
      resize: vertical;
      outline: none;
      tab-size: 2;
    }
    #editor:focus { border-color: var(--border-focus); }
    #editor::placeholder { color: var(--text-muted); }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .query-meta {
      font-size: 12px;
      color: var(--text-dim);
    }
    .query-meta strong { color: var(--text); font-weight: 600; }

    /* ── Results ── */
    .results-section {
      flex: 1;
      overflow: hidden;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-elevated);
      display: flex;
      flex-direction: column;
    }
    .placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 13px;
    }
    .error-box {
      padding: 14px 16px;
      color: var(--red);
      font-family: var(--font-mono);
      font-size: 12px;
      white-space: pre-wrap;
      overflow: auto;
    }
    .table-wrap {
      flex: 1;
      overflow: auto;
    }
    .table-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th {
      text-align: left;
      padding: 8px 14px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-dim);
      white-space: nowrap;
    }
    td {
      padding: 5px 14px;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 12px;
      max-width: 320px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }
    td.null-val {
      color: var(--text-muted);
      font-style: italic;
    }
    tr:hover td { background: var(--bg-hover); }

    /* ── Overlay ── */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }
    .overlay-box {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 32px;
      min-width: 360px;
      max-width: 440px;
      text-align: center;
    }
    .overlay-box h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .overlay-box p {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .overlay-box .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Loading bar ── */
    .loading-bar {
      height: 2px;
      background: var(--accent);
      animation: loadbar 1.2s ease-in-out infinite;
      border-radius: 2px;
    }
    @keyframes loadbar {
      0% { width: 0%; margin-left: 0; }
      50% { width: 60%; margin-left: 20%; }
      100% { width: 0%; margin-left: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="rgba(99,102,241,0.2)" stroke="#6366f1"/>
      </svg>
      Stripe Sync Explorer
    </div>
    <div class="header-right">
      <div class="status-pill" id="statusPill">
        <span class="dot"></span>
        <span id="statusText">Connected</span>
      </div>
      <button class="btn-danger" id="nukeBtn">Nuke &amp; Resync</button>
    </div>
  </header>

  <div class="main">
    <aside>
      <div class="sidebar-header">Saved Queries</div>
      <div class="query-list" id="queryList"></div>
    </aside>

    <div class="content">
      <div class="editor-wrap">
        <textarea
          id="editor"
          spellcheck="false"
          placeholder="SELECT * FROM stripe.customers LIMIT 10;"
        ></textarea>
      </div>
      <div class="toolbar">
        <button class="btn-primary" id="runBtn">
          Run Query <kbd>Ctrl+Enter</kbd>
        </button>
        <div class="query-meta" id="queryMeta"></div>
      </div>
      <div class="results-section" id="resultsSection">
        <div class="placeholder" id="placeholder">
          Run a query or click a saved query to see results
        </div>
        <div class="error-box" id="errorBox" style="display:none"></div>
        <div class="table-wrap" id="tableWrap" style="display:none">
          <table>
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div class="overlay" id="confirmOverlay" style="display:none">
    <div class="overlay-box">
      <h3>Nuke &amp; Resync</h3>
      <p>
        This will <strong>delete all synced Stripe data</strong> and run a fresh
        migration + backfill. This may take several minutes depending on your
        Stripe account size.
      </p>
      <div class="actions">
        <button class="btn-ghost" id="cancelBtn">Cancel</button>
        <button class="btn-danger" id="confirmBtn">Yes, Nuke &amp; Resync</button>
      </div>
    </div>
  </div>

  <!-- Sync Progress Overlay -->
  <div class="overlay" id="syncOverlay" style="display:none">
    <div class="overlay-box">
      <div class="spinner"></div>
      <h3 id="syncTitle">Syncing...</h3>
      <p id="syncMessage">Preparing...</p>
    </div>
  </div>

  <script>
    // ── State ──
    let queries = [];
    let activeQueryId = null;
    let isRunning = false;

    // ── DOM refs ──
    const editor = document.getElementById('editor');
    const runBtn = document.getElementById('runBtn');
    const queryMeta = document.getElementById('queryMeta');
    const queryList = document.getElementById('queryList');
    const placeholder = document.getElementById('placeholder');
    const errorBox = document.getElementById('errorBox');
    const tableWrap = document.getElementById('tableWrap');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const nukeBtn = document.getElementById('nukeBtn');
    const confirmOverlay = document.getElementById('confirmOverlay');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const syncOverlay = document.getElementById('syncOverlay');
    const syncTitle = document.getElementById('syncTitle');
    const syncMessage = document.getElementById('syncMessage');
    const statusPill = document.getElementById('statusPill');
    const statusText = document.getElementById('statusText');

    // ── Init ──
    async function init() {
      try {
        const res = await fetch('/api/queries');
        queries = await res.json();
        renderSidebar();
      } catch (e) {
        console.error('Failed to load queries:', e);
      }
      editor.focus();
    }

    function renderSidebar() {
      queryList.innerHTML = queries.map(q => `
        <div class="query-card" data-id="${q.id}">
          <div class="q-name">${esc(q.name)}</div>
          <div class="q-desc">${esc(q.description)}</div>
        </div>
      `).join('');

      queryList.querySelectorAll('.query-card').forEach(card => {
        card.addEventListener('click', () => {
          const q = queries.find(x => x.id === card.dataset.id);
          if (q) {
            editor.value = q.sql;
            setActiveQuery(q.id);
            runQuery();
          }
        });
      });
    }

    function setActiveQuery(id) {
      activeQueryId = id;
      queryList.querySelectorAll('.query-card').forEach(c => {
        c.classList.toggle('active', c.dataset.id === id);
      });
    }

    // ── Run Query ──
    async function runQuery() {
      const sql = editor.value.trim();
      if (!sql || isRunning) return;

      isRunning = true;
      runBtn.disabled = true;
      queryMeta.textContent = 'Running...';
      showView('loading');

      try {
        const res = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql }),
        });
        const data = await res.json();

        if (data.error) {
          showError(data.error);
          queryMeta.textContent = '';
        } else {
          renderTable(data.columns, data.rows);
          queryMeta.innerHTML = `<strong>${data.rowCount ?? data.rows.length}</strong> row${data.rows.length !== 1 ? 's' : ''} &middot; ${data.elapsed}ms`;
        }
      } catch (err) {
        showError(err.message || 'Network error');
        queryMeta.textContent = '';
      } finally {
        isRunning = false;
        runBtn.disabled = false;
      }
    }

    // ── Render ──
    function showView(mode) {
      placeholder.style.display = mode === 'placeholder' ? 'flex' : 'none';
      errorBox.style.display = mode === 'error' ? 'block' : 'none';
      tableWrap.style.display = mode === 'table' ? 'block' : 'none';
    }

    function showError(msg) {
      showView('error');
      errorBox.textContent = msg;
    }

    function renderTable(cols, rows) {
      if (!cols.length) {
        queryMeta.innerHTML = '<strong>Query executed</strong> (no result set)';
        showView('placeholder');
        placeholder.textContent = 'Query executed successfully (no rows returned)';
        return;
      }

      tableHead.innerHTML = '<tr>' + cols.map(c => `<th>${esc(c)}</th>`).join('') + '</tr>';
      tableBody.innerHTML = rows.map(row =>
        '<tr>' + cols.map(c => {
          const v = row[c];
          if (v === null || v === undefined) return `<td class="null-val">NULL</td>`;
          if (typeof v === 'object') return `<td title="${esc(JSON.stringify(v, null, 2))}">${esc(JSON.stringify(v))}</td>`;
          const s = String(v);
          return `<td title="${esc(s)}">${esc(s.length > 120 ? s.slice(0, 120) + '...' : s)}</td>`;
        }).join('') + '</tr>'
      ).join('');

      showView('table');
    }

    // ── Nuke & Resync ──
    nukeBtn.addEventListener('click', () => {
      confirmOverlay.style.display = 'flex';
    });
    cancelBtn.addEventListener('click', () => {
      confirmOverlay.style.display = 'none';
    });
    confirmBtn.addEventListener('click', async () => {
      confirmOverlay.style.display = 'none';
      syncOverlay.style.display = 'flex';
      syncTitle.textContent = 'Syncing...';
      syncMessage.textContent = 'Starting nuke & resync...';
      statusPill.className = 'status-pill syncing';
      statusText.textContent = 'Syncing';

      try {
        await fetch('/api/nuke', { method: 'POST' });
        pollSyncStatus();
      } catch (err) {
        syncTitle.textContent = 'Error';
        syncMessage.textContent = err.message;
      }
    });

    async function pollSyncStatus() {
      while (true) {
        await sleep(2000);
        try {
          const res = await fetch('/api/status');
          const data = await res.json();
          syncMessage.textContent = data.message || '...';

          if (data.status === 'idle') {
            statusPill.className = 'status-pill';
            statusText.textContent = 'Connected';
            syncOverlay.style.display = 'none';
            break;
          }
          if (data.status === 'error') {
            statusPill.className = 'status-pill error';
            statusText.textContent = 'Error';
            syncTitle.textContent = 'Sync Failed';
            syncMessage.textContent = data.message;
            // Keep overlay open so user sees the error
            await sleep(5000);
            syncOverlay.style.display = 'none';
            break;
          }
        } catch {
          // Ignore poll errors, try again
        }
      }
    }

    // ── Event Listeners ──
    runBtn.addEventListener('click', runQuery);
    editor.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runQuery();
      }
      // Tab inserts spaces
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart;
        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(editor.selectionEnd);
        editor.selectionStart = editor.selectionEnd = start + 2;
      }
    });
    // Clear active query when user edits manually
    editor.addEventListener('input', () => {
      if (activeQueryId) setActiveQuery(null);
    });

    // ── Helpers ──
    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    init();
  </script>
</body>
</html>
